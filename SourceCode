 #include <SPI.h>
#include <MFRC522.h>
#include <LiquidCrystal.h>
#include <Keypad.h>
#include <Wire.h>

// === LCD setup ===
const int lcdRS = 11;
const int lcdE  = 13;
const int lcdD4 = A1;
const int lcdD5 = A2;
const int lcdD6 = A3;
const int lcdD7 = A4;
LiquidCrystal lcd(lcdRS, lcdE, lcdD4, lcdD5, lcdD6, lcdD7);

// === RFID setup ===
#define SS_PIN   10
#define RST_PIN  9
MFRC522 mfrc522(SS_PIN, RST_PIN);

// === Keypad setup ===
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};
byte rowPins[ROWS] = {22, 24, 26, 28};
byte colPins[COLS] = {30, 32, 34, 36};
Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// === Password logic ===
const String correctCode = "7456";
String inputCode = "";
bool unlocked = false;

// === Allowed RFID UID (change this to match your card) ===
const String allowedUID = "631BA536";

void setup() {
  Wire.begin();           // Start I2C as master
  SPI.begin();
  mfrc522.PCD_Init();

  lcd.begin(16,2);
  lcd.print("Enter code/card:");

  Serial.begin(9600);
  Serial.println("Master Ready");
}

void loop() {
  char key = keypad.getKey();

  if (key) {
    if (unlocked && key == 'A') {
      // Relock
      unlocked = false;
      sendToSlave("LOCK");
      lcd.clear();
      lcd.print("Locked");
      delay(1000);
      lcd.clear();
      lcd.print("Enter code/card:");
      inputCode = "";
      return;
    }

    if (!unlocked) {
      if (key >= '0' && key <= '9') {
        inputCode += key;
        lcd.setCursor(inputCode.length()-1,1);
        lcd.print("*");
      }

      if (inputCode.length() >= 4) {
        if (inputCode == correctCode) {
          unlocked = true;
          sendToSlave("UNLOCK");
          lcd.clear();
          lcd.print("Unlocked (code)");
        } else {
          lcd.clear();
          lcd.print("Wrong code");
          delay(1000);
          lcd.clear();
          lcd.print("Enter code/card:");
        }
        inputCode = "";
      }
    }
  }

  // --- RFID logic ---
  if (!unlocked) {
    if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {
      String uidStr = "";
      for (byte i = 0; i < mfrc522.uid.size; i++) {
        if (mfrc522.uid.uidByte[i] < 0x10) uidStr += "0";
        uidStr += String(mfrc522.uid.uidByte[i], HEX);
      }
      uidStr.toUpperCase();

      Serial.print("Scanned UID: ");
      Serial.println(uidStr);

      if (uidStr == allowedUID) {
        unlocked = true;
        sendToSlave("UNLOCK");
        lcd.clear();
        lcd.print("Unlocked (card)");
      } else {
        lcd.clear();
        lcd.print("Access Denied");
        delay(1000);
        lcd.clear();
        lcd.print("Enter code/card:");
      }

      mfrc522.PICC_HaltA();

      mfrc522.PCD_StopCrypto1();
    }
  }}

// === Helper: send command to Uno ===
void sendToSlave(String command) {
  Wire.beginTransmission(8);
  Wire.write(command.c_str());
  Wire.endTransmission();
  Serial.print("Sent to Slave: ");
  Serial.println(command);
}

